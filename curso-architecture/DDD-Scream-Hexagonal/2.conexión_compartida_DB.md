# ğŸ”Œ ConexiÃ³n Compartida - ExplicaciÃ³n DidÃ¡ctica

> Te explico de manera simple cÃ³mo funciona la conexiÃ³n compartida:

# ğŸ  AnalogÃ­a: Casa con Servicios Compartidos

> Imagina que tienes una casa grande con varios departamentos (bounded contexts):

```plaintext
ğŸ  CASA (AplicaciÃ³n)
â”œâ”€â”€ ğŸª Departamento "Tienda" (order-management)
â”œâ”€â”€ ğŸ‘¥ Departamento "Usuarios" (user-management)
â””â”€â”€ ğŸ”Œ Servicios Compartidos (shared)
    â”œâ”€â”€ ğŸ’¡ Electricidad (Database Connection)
    â”œâ”€â”€ ğŸ’§ Agua (Config)
    â””â”€â”€ ğŸŒ Internet (Logging)
```

# âš¡ Â¿CÃ³mo Funciona la Electricidad (DB Connection)?

## âŒ MALO: Cada departamento su propio medidor

```plaintext
ğŸª Tienda â†’ ğŸ”Œ Medidor A â†’ âš¡ Red ElÃ©ctrica
ğŸ‘¥ Usuarios â†’ ğŸ”Œ Medidor B â†’ âš¡ Red ElÃ©ctrica
```

### Problemas:

- Costoso (mÃ¡s medidores)
- Ineficiente (mÃºltiples conexiones)
- DifÃ­cil mantenimiento

## âœ… BUENO: Un solo medidor, mÃºltiples enchufes

```plaintext
ğŸ  Casa â†’ ğŸ”Œ Medidor Principal â†’ âš¡ Red ElÃ©ctrica
     â”œâ”€â”€ ğŸª Tienda (usa enchufes)
     â””â”€â”€ ğŸ‘¥ Usuarios (usa enchufes)
```

### Ventajas:

- Un solo punto de conexiÃ³n
- Eficiencia compartida
- FÃ¡cil mantenimiento

## ğŸ”„ En TÃ©rminos de Base de Datos

### ğŸ”Œ Connection Pool = Medidor Principal

```js
// UN SOLO POOL para toda la aplicaciÃ³n
const pool = new Pool({
  host: "database-server",
  max: 20, // mÃ¡ximo 20 conexiones simultÃ¡neas
});
```

### ğŸª Cada Bounded Context = Departamento

```js
// Order Management "usa" el pool
class OrderRepository {
  constructor(pool) {
    this.pool = pool; // Recibe el pool compartido
  }

  async save(order) {
    const client = await this.pool.connect(); // "Enchufa"
    // Hacer queries...
    client.release(); // "Desenchufa"
  }
}

// User Management tambiÃ©n "usa" el mismo pool
class UserRepository {
  constructor(pool) {
    this.pool = pool; // El MISMO pool
  }
}
```

### ğŸ¯ Flujo Simple

1. Inicio de la AplicaciÃ³n ğŸš€

```plaintext
server.ts:
  1. Crear 1 pool de conexiones
  2. Pasarlo a cada bounded context
  3. Cada context lo usa para sus repositorios
```

2. Cuando llega una Request ğŸ“¨

```plaintext
HTTP Request â†’ OrderController
    â†“
OrderUseCase â†’ OrderRepository
    â†“
repository.pool.connect()  â† "Pide una conexiÃ³n"
    â†“
Ejecuta SQL
    â†“
client.release()  â† "Devuelve la conexiÃ³n"
```

## ğŸ”„ Â¿Por quÃ© Compartir la ConexiÃ³n?

### ğŸ’° Eficiencia

- 20 conexiones para TODA la app
- En lugar de 20 Ã— 2 contexts = 40 conexiones

### âš¡ Performance

- Pool reutiliza conexiones existentes
- No crear/destruir conexiones constantemente

### ğŸ›ï¸ Control Centralizado

- Una sola configuraciÃ³n de DB
- FÃ¡cil cambiar host, credentials, etc.

### ğŸ“Š Monitoring

- Ver todas las conexiones en un lugar
- Detectar problemas fÃ¡cilmente

## ğŸ—ï¸ En la PrÃ¡ctica

**Paso 1:** Crear Pool (Una vez)

```js
// Al inicio de la app
const sharedPool = createDatabasePool();
```

**Paso 2:** Inyectar en Factories

```js
// Cada bounded context recibe el mismo pool
const orderFactory = new OrderFactory(sharedPool);
const userFactory = new UserFactory(sharedPool);
```

**Paso 3:** Usar en Repositories

```js
// Dentro de cada repository
const connection = await this.pool.connect();
// Hacer query
connection.release();
```

## ğŸ¤” Â¿Y la Independencia de Bounded Contexts?

###âœ… SÃ son independientes en:

- LÃ³gica de negocio (domain/application)
- Schemas de tablas (orders vs users tables)
- Queries especÃ­ficas (cada uno sus SQLs)
- EvoluciÃ³n (cambiar OrderRepository sin afectar UserRepository)

### ğŸ”„ Solo comparten:

- La tuberÃ­a (connection pool)
- La configuraciÃ³n (host, port, credentials)

### ğŸ¨ AnalogÃ­a Final: Restaurante

```plaintext
ğŸ½ï¸ RESTAURANTE (AplicaciÃ³n)
â”œâ”€â”€ ğŸ‘¨â€ğŸ³ Cocina (order-management)
â”œâ”€â”€ ğŸ§‘â€ğŸ’¼ Meseros (user-management)
â””â”€â”€ ğŸ”§ Servicios Compartidos
    â”œâ”€â”€ ğŸ’¡ Luz (DB Connection)
    â”œâ”€â”€ ğŸ”¥ Gas (Config)
    â””â”€â”€ ğŸ’§ Agua (Logging)
```

- Cocina y Meseros tienen trabajos completamente diferentes
- Pero ambos usan la misma electricidad, gas, agua
- Eficiente: No necesitas 2 medidores de luz
- Independientes: Cocina puede cambiar sus procesos sin afectar a Meseros
